import Arduino_Board_Discovery from '../images/device/Arduino_Board_Discovery.png' 
import Arduino_Board_PartNumber from '../images/device/Arduino_Board_PartNumber.png' 
import Arduino_Compile from '../images/device/Arduino_Compile.png' 
import LongFi_Example from '../images/device/LongFi_Example.png' 
import LongFi_Library from '../images/device/LongFi_library.png' 
import upload_sketch from '../images/device/upload_sketch.png' 
import upload_success from '../images/device/Arduino_Upload_Successful.png'
import request_bin from '../images/console/request_bin.png' 
import pasted_endpoint from '../images/console/pasted_endpoint.png' 
import set_channel_as_default from '../images/console/set_channel_as_default.gif' 
import device_packets from '../images/console/test_packets.png'

# LongFi Arduino Quickstart Guide
 
> ##### Important!  

#### Before we begin, please make sure you've followed the steps from this [quickstart](/quickstart), which goes over some initial setup steps. 

## Introduction
One of our main organizational objectives is to maximize adoption and usage of the Helium Network. Helium’s LongFi protocol is a sub-GHz wireless protocol purpose-built for a wireless peer-to-peer network for low-bandwidth IoT applications. To help facilitate this hardware product development cycle, we have provided an Arduino wrapper for our LongFi protocol.

This guide will show you step by step how to transmit LongFi packets using a longfi-arduino example on an STMicroelectronics B-L072Z-LRWAN1 Discovery kit. The open-source Arduino platform provides easy to use hardware and software and decreases the technical overhead for beginners. 

## Objective 

In this guide, you will learn:

* How to setup your environment (Add STM32 board support to Arduino and STLink debugging utility)
* How to build and program a basic application that will send packets on the Helium Network
* How to route the packets from your device to an HTTP endpoint using the Helium Console.
* Verify real time packets sent to a Helium Hotspot and routed to an HTTP endpoint. 
 
For this example, you’ll need the following:

### Hardware
 
* <a href="https://www.st.com/en/evaluation-tools/b-l072z-lrwan1.html" target="_blank">STMicroelectronics B-L072Z-LRWAN1 Discovery kit</a>
* Micro USB Type B Cable - <a href="https://www.amazon.com/AmazonBasics-Male-Micro-Cable-Black/dp/B0719H12WD/ref=sr_1_2_sspa?" target="_blank">Example </a>

### Software

* <a href="https://www.arduino.cc/en/Main/Software" target="_blank">Arduino software (IDE)</a> 
* <a href="https://github.com/stm32duino/Arduino_Core_STM32#getting-started" target="_blank">STM32 Board Support</a> 
* <a href="https://www.st.com/en/development-tools/stm32cubeprog.html" target="_blank">STLink Debugging Utility</a> 
* <a href="https://console.helium.com/" target="_blank">Helium Console</a> 

## Hardware setup

The build for this project is easy! You’ll just need to install the included antenna.  
 
We'll be using the ST-Link debugger on the Discovery board, so you'll want to connect the micro-USB B connector to the micro-USB port labeled `CN7 USB STLINK`.
 
That’s it for the hardware setup! Next we will setup your environment. We will be using the Arduino IDE. 

## Getting the Arduino IDE
 
Download and install the latest version of <a href="https://www.arduino.cc/en/Main/Software" target="_blank">Arduino IDE </a> for your preferred OS. 
 
* <a href="https://www.arduino.cc/en/Guide/Windows" target="_blank">Windows </a>
* <a href="https://www.arduino.cc/en/Guide/linux" target="_blank">Linux </a>
* <a href="https://www.arduino.cc/en/Guide/MacOSX" target="_blank">Mac OSX</a>

## Add STM32 board support to Arduino
 
<a href="https://github.com/stm32duino/wiki/wiki/Getting-Started" target="_blank">Instructions to add STM32 board support to Arduino</a> 

## Getting access to the LongFi TransmitPacket Sketch
 
This Arduino library needs to be manually installed as it has not been added to the Arduino Library registry yet. 
 
Clone the longfi-arduino repository by using the following command ... 

```
git clone git@github.com:helium/longfi-arduino.git
```

... to the following directory:
 
```
linux: /home/{user}/Arduino/libraries
windows: Documents/Arduino/libraries
mac os: Documents/Arduino/libraries
```

Then restart your Arduino IDE to load the library. 
 
## IMPORTANT TEMPORARY STEP

This step is currently necessary until the fix gets pushed to the board support packages. 

<a href="https://github.com/helium/longfi-arduino/blob/master/B-L072Z-LRWAN1-board-support-fix.md" target="_blank">Link to fix</a> 

## Using the LongFi Device library
 
Arduino IDE: 
 
```
Sketch -> Include Library -> LongFi
```
 
<img src={LongFi_Library} />

## LongFi TransmitPacket Example Sketch 

Arduino IDE:

```
File -> Examples -> LongFi -> TransmitPacket
```
 
 <img src={LongFi_Example} /> 
 
For the initial Beta, we only support one OUI - Organizationally Unique Identifier for routing device packets. 
Make sure the OUI is set properly in the sketch. 
The device_id should correspond with the device you onboard on Console.

```
// set OUI and device_id to work with LongFi routing
const uint32_t oui = 1;
const uint16_t device_id = 2;
const uint8_t preshared_key[16] = {0xF4, 0xF2, 0xAB, 0x28, 0xA9, 0x9B, 0xAB, 0x44, 0x95, 0x71, 0x52, 0x4E, 0xE1, 0xCA, 0x13, 0xCE};
```
 
 ## Configuring the Arduino IDE for the B-L072Z-LRWAN1 - ST STM32L0 Discovery kit
 
Instructions to install the board support package can be found <a href="https://github.com/stm32duino/Arduino_Core_STM32#getting-started" target="_blank">here</a> 


Arduino IDE:
 
```
Select Tools -> Board -> Discovery
```
 
<img src={Arduino_Board_Discovery} /> 
 

```
Select Tools -> Board part number -> Discovery L072Z-LRWAN1
```

<img src={Arduino_Board_PartNumber} /> 

## Programming (Upload Method)

We will use the onboard ST-Link (Flasher/Debugger) to upload this sketch. 
 
Download and install the required utility from ST <a href="https://www.st.com/en/development-tools/stm32cubeprog.html" target="_blank">here</a> 

The download comes in the form of a `stm32cubeprog.zip` file, which you'll need to unpack. After you unzip, you should see the following files:

```
SetupSTM32CubeProgrammer-[version].exe
SetupSTM32CubeProgrammer-[version].linux
SetupSTM32CubeProgrammer-[version].app
```

### Installation Requirements

Supported operating systems and architectures:
* Linux 64-bit 
* Windows 7/8/10 32-bit and 64-bit 
* MacOS (minimum version OS X Yosemite)
* Java SE Run Time Environment 1.8 or newer must be installed (from Oracle)
* If OpenJDK is used, you must download and install the OpenJFx library. 

### Windows Instructions

The download comes with a `SetupSTM32CubeProgrmamer-[version].exe`, which guides you through the installation process. 

### Linux Instructions

The download comes with a `SetupSTM32CubeProgrammer-[version].linux`, which guides you through the installation process. 

### MacOS Instructions

Run the following command: 

`java -jar SetupSTM32CubeProgrammer-[version].exe`

Alternatively, you can run the `SetupSTM32CubeProgrammer-[version].app` which guides you through the installation process. 

**You should only use the default installation path.** 
## 

Arduino IDE:

```
Select Tools -> Upload Method -> STM32CubeProgrammer(SWD)
```

<img src={upload_sketch} /> 

## Programming your Arduino Sketch

Arduino IDE:

```
Select Sketch -> Verify/Compile (Ctrl + R)
```
 
 <img src={Arduino_Compile} /> 
 
If there are no errors with your sketch, you should see `Done Compiling`

Then, you can upload the sketch and program the development board. 
 
Arduino IDE:

```
Select Sketch -> Upload (Ctrl + U)
```
 
<img src={upload_success} />
 
Congratulations! You have just programmed your first Helium LongFi application! 

However, we are not done just yet. Now we have to switch back into Console to setup our channels and packet routing.  

## Channels

Create channels to route your device data to its final destination. Channels, when set up correctly, make it easy to forward data to popular cloud services such as Google Cloud IoT, Microsoft Azure, Amazon, and more. 

Once you set up a channel, it can be selected and used with any device.

**During the SDK Beta, only HTTP channels are available.**

### Add an HTTP Channel

To add a channel, go to **Channels** on the left menu. Select the channel to add - in this case, the **HTTP** channel.

The next step is to paste the HTTP endpoint.

If you're still testing, you can find popular sites that can create HTTP endpoints for you and inspect packets. <a href="https://www.requestbin.com">Requestbin </a> and <a href="https://www.beeceptor.com">Beeceptor </a>provide tools to make an HTTP endpoint quickly and easily.

### Requestbin Example
Create an endpoint by going to requestbin.com and click **Create a Request Bin**. Once created, copy the endpoint..

<img src={request_bin} />

... and paste it in Console.

<img src={pasted_endpoint} />

**HTTP Header** and **Value** are not required and those can be left blank. 

Lastly, provide a name for the channel. Names do not have to be unique.

Click **Create Channel**.

Your new channel is now ready for use.

### Set Default Channel 
[setchannel]: #setchannel

To set a channel as the default for all newly created devices, go to **Channels** on the left menu and click **Set Default** for the desired channel. 

<img src={set_channel_as_default} />

### Set Multiple Channels
Devices can send the same data packet to multiple channels at once. This is a cost-effective way to send the same information to many places at once without re-sending the data from the IoT device.

To send to another channel, click **Connect Channel**, select a channel, and click **Add**.

### Real Time Packets

Let's go back to **Devices** and select the device that you have created. 

Now we can watch in real time as data packets flow through the Helium Network. 

<img src={device_packets} />

When a valid data packet is received from that device, a dot will appear from the left side of the chart and flow towards the right as time goes on. The size of the dot is related to the size of the packet. Larger sized packets will be a larger dot, and small data packets will be a smaller dot. 

**Real Time Packets are available only in an active Console session**
View packets as they come in real time. If you close the window or the window is no longer active, data will not appear. 

#### Now we are finished with this example! Congratulations! We have successfully built a device that can communicate via LongFi on the Helium Network! 

